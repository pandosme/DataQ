<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geospace</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/app.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="js/jquery-3.7.1.min.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="js/paho-mqtt-min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-rotate@0.2.8/dist/leaflet-rotate-src.js"></script>
  <style>
    #map { height: 600px; width: 100%; border-radius: 4px; cursor: crosshair; }
    .map-hint {
      position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.65); color: #fff;
      padding: 6px 14px; border-radius: 20px; font-size: 13px;
      pointer-events: none; z-index: 1000; white-space: nowrap;
    }
    .radar-config-panel { background: #f8f9fa; border-radius: 6px; padding: 14px 18px; margin-bottom: 14px; }
    .compass-wrap { display: flex; align-items: center; gap: 12px; }
    .compass-svg { flex-shrink: 0; }
    .tracker-label {
      background: rgba(0,0,0,0.65); color: #fff;
      border-radius: 4px; padding: 2px 6px;
      font-size: 12px; white-space: nowrap;
      border: 1px solid rgba(255,255,255,0.4);
    }
  </style>
</head>
<body>
<div class="d-flex" id="wrapper">
  <!-- Sidebar -->
  <div class="bg-light border-right" id="sidebar-wrapper">
    <div class="sidebar-heading">&nbsp;</div>
    <div class="list-group list-group-flush">
            <a href="index.html" class="list-group-item list-group-item-action">Overview</a>
            <a href="events.html" class="list-group-item list-group-item-action">Events</a>
            <a href="detections.html" class="list-group-item list-group-item-action">Detections</a>
            <a href="trackers.html" class="list-group-item list-group-item-action">Trackers</a>
            <a href="paths.html" class="list-group-item list-group-item-action">Paths</a>
            <a href="occupancy.html" class="list-group-item list-group-item-action">Occupancy</a>
            <a href="geospace.html" class="list-group-item list-group-item-action active">Geospace</a>
            <hr class="sidebar-divider">
            <a href="mqtt.html" class="list-group-item list-group-item-action">MQTT Settings</a>
            <a href="advanced.html" class="list-group-item list-group-item-action">Advanced</a>
            <a href="about.html" class="list-group-item list-group-item-action">About</a>
        </div>
    </div>

  <!-- Page Content -->
  <div id="page-content-wrapper" class="p-0">
    <div class="container-fluid">
      <div class="col-12">
        <div class="card">

          <!-- Card header: publish toggle + connection status -->
          <div class="card-header d-flex justify-content-between align-items-center">
            <div class="publish-control">
              <label class="switch">
                <input type="checkbox" id="pageToggle">
                <span class="slider round"></span>
              </label>
              <span class="switch-label">Publish Geospace</span>
            </div>
            <div id="connectionStatus" class="connection-status">
              <span id="statusMessage">Connecting</span>
            </div>
          </div>

          <div id="locationContent" class="location-content">
            <div class="card-body">

              <!-- Radar configuration panel -->
              <div class="radar-config-panel">
                <div class="row align-items-center g-3">

                  <!-- Position inputs -->
                  <div class="col-auto">
                    <label class="form-label mb-1 fw-semibold">Radar position</label>
                    <div class="d-flex gap-2">
                      <div>
                        <small class="text-muted d-block">Latitude</small>
                        <input type="number" id="radar-lat" class="form-control form-control-sm"
                               step="0.000001" style="width:130px" placeholder="59.123456">
                      </div>
                      <div>
                        <small class="text-muted d-block">Longitude</small>
                        <input type="number" id="radar-lon" class="form-control form-control-sm"
                               step="0.000001" style="width:130px" placeholder="18.123456">
                      </div>
                    </div>
                  </div>

                  <!-- Divider -->
                  <div class="col-auto"><div style="height:48px;border-left:1px solid #dee2e6"></div></div>

                  <!-- Heading input + compass -->
                  <div class="col-auto">
                    <label for="radar-heading" class="form-label mb-1 fw-semibold">
                      Heading <small class="text-muted fw-normal">(compass °, 0 = North)</small>
                    </label>
                    <div class="compass-wrap">
                      <!-- Compass SVG: 60px circle, arrow rotates to heading -->
                      <svg id="compass-svg" class="compass-svg" width="60" height="60" viewBox="0 0 60 60">
                        <circle cx="30" cy="30" r="28" fill="#e9ecef" stroke="#adb5bd" stroke-width="1.5"/>
                        <text x="30" y="10"  text-anchor="middle" font-size="9" fill="#495057">N</text>
                        <text x="30" y="55"  text-anchor="middle" font-size="9" fill="#495057">S</text>
                        <text x="7"  y="33"  text-anchor="middle" font-size="9" fill="#495057">W</text>
                        <text x="53" y="33"  text-anchor="middle" font-size="9" fill="#495057">E</text>
                        <!-- Arrow group rotated around centre -->
                        <g id="compass-arrow" transform="rotate(0,30,30)">
                          <polygon points="30,8 33,30 30,26 27,30" fill="#dc3545"/>
                          <polygon points="30,52 33,30 30,34 27,30" fill="#6c757d"/>
                        </g>
                      </svg>
                      <input type="number" id="radar-heading" class="form-control"
                             min="0" max="360" step="1" value="0"
                             style="width:90px">
                    </div>
                  </div>

                  <!-- Divider -->
                  <div class="col-auto"><div style="height:48px;border-left:1px solid #dee2e6"></div></div>

                  <!-- Units -->
                  <div class="col-auto">
                    <label for="geo-units" class="form-label mb-1 fw-semibold">Units</label>
                    <select class="form-select form-select-sm" id="geo-units" style="width:auto">
                      <option value="1">Metric (m, km/h)</option>
                      <option value="2">US customary (ft, mph)</option>
                    </select>
                  </div>

                  <!-- Save -->
                  <div class="col-auto ms-auto">
                    <button type="button" class="btn btn-success" id="btn-save-radar">Save</button>
                  </div>

                </div><!-- /.row -->
              </div><!-- /.radar-config-panel -->

              <!-- Map -->
              <div style="position:relative">
                <div id="map"></div>
                <div id="map-hint" class="map-hint">Click on the map to place the radar position</div>
              </div>

            </div><!-- /.card-body -->
          </div><!-- /#locationContent -->
        </div><!-- /.card -->
      </div>
    </div>
  </div>

  <div class="toast-container position-fixed top-0 end-0 p-3"></div>
</div>

<script>
/* ============================================================
   State
   ============================================================ */
const AppState = {
    map:          null,
    geoData:      { lat: 0, lng: 0 },
    heading:      0,
    radarMarker:  null,
    headingLine:  null,
    headingArrow: null,   // filled triangle at beam tip
    fovPolygon:   null,   // 180° radar coverage sector
    trackers:     new Map()   // id → Leaflet marker
};

var App = null;
var MQTT_Client = null;

/* ============================================================
   Boot
   ============================================================ */
$(document).ready(() => {
    initApp().catch(err => {
        showToast('Initialisation failed: ' + err.message, 'danger');
    });
});

async function initApp() {
    App = await $.ajax({ url: 'app', dataType: 'json' });

    document.title = App.manifest.acapPackageConf.setup.friendlyName;
    $('.sidebar-heading').text(document.title);

    /* Publish toggle */
    const toggle  = document.getElementById('pageToggle');
    const content = document.getElementById('locationContent');
    toggle.checked = !!App.settings.publish.geospace;
    content.classList.toggle('hidden', !App.settings.publish.geospace);
    toggle.addEventListener('change', function() {
        App.settings.publish.geospace = this.checked;
        content.classList.toggle('hidden', !this.checked);
        saveSetting({ publish: App.settings.publish });
    });

    /* Position and heading from settings.location (saved by this page) */
    const loc = App.settings.location || {};
    AppState.geoData.lat = loc.lat || 0;
    AppState.geoData.lng = loc.lon || 0;

    /* Populate position inputs */
    if (AppState.geoData.lat) $('#radar-lat').val(AppState.geoData.lat.toFixed(7));
    if (AppState.geoData.lng) $('#radar-lon').val(AppState.geoData.lng.toFixed(7));

    /* Heading from settings.location */
    AppState.heading = (loc.heading != null) ? loc.heading : 0;
    $('#radar-heading').val(AppState.heading);
    updateCompass(AppState.heading);

    /* Units */
    $('#geo-units').val(App.settings.scene && App.settings.scene.units ? App.settings.scene.units : 1);

    /* Save button */
    $('#btn-save-radar').on('click', saveRadarConfig);

    /* Live heading preview — update compass AND beam AND map rotation */
    $('#radar-heading').on('input', function() {
        const h = parseFloat(this.value) || 0;
        updateCompass(h);
        AppState.heading = h;
        updateHeadingLine(h);
        rotateMap(h);
    });

    /* Map */
    initMap();

    /* MQTT */
    if (App.status.mqtt.connected) {
        connectMQTT();
    } else {
        updateConnectionStatus('disconnected');
        setTimeout(() => showToast('Not connected to broker. Go to MQTT Settings.', 'warning'), 200);
    }
}

/* ============================================================
   Map
   ============================================================ */
function initMap() {
    const lat = AppState.geoData.lat;
    const lng = AppState.geoData.lng;
    const hasPos = (lat !== 0 || lng !== 0);
    const zoom = hasPos ? 18 : 4;
    const center = hasPos ? [lat, lng] : [20, 0];

    AppState.map = L.map('map', {
        rotate:        true,
        rotateControl: { closeOnZeroBearing: false },
        maxZoom: 22,
        zoomControl: true
    }).setView(center, zoom);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap',
        maxZoom: 22,
        maxNativeZoom: 19
    }).addTo(AppState.map);

    /* Try browser geolocation to center map when device has no coords yet */
    if (!hasPos && navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
            AppState.map.setView([pos.coords.latitude, pos.coords.longitude], 16);
        });
    }

    if (hasPos) {
        placeRadarMarker(lat, lng);
        updateHeadingLine(AppState.heading);
        rotateMap(AppState.heading);
    }

    /* Click map to place / move radar marker */
    AppState.map.on('click', function(e) {
        placeRadarMarker(e.latlng.lat, e.latlng.lng);
        updateHeadingLine(AppState.heading);
    });
}

/**
 * Place or move the radar crosshair marker to [lat, lng].
 * Updates the input fields and hides the map hint.
 */
function placeRadarMarker(lat, lng) {
    AppState.geoData.lat = lat;
    AppState.geoData.lng = lng;

    $('#radar-lat').val(lat.toFixed(7));
    $('#radar-lon').val(lng.toFixed(7));
    $('#map-hint').hide();

    if (AppState.radarMarker) {
        AppState.radarMarker.setLatLng([lat, lng]);
    } else {
        AppState.radarMarker = L.marker([lat, lng], {
            icon:      radarCrosshairIcon(),
            draggable: true,
            title:     'Drag to adjust radar position'
        }).addTo(AppState.map).bindPopup('Radar \u2014 drag to reposition');

        /* Dragging updates inputs + heading beam live */
        AppState.radarMarker.on('drag', function(e) {
            const p = e.latlng;
            AppState.geoData.lat = p.lat;
            AppState.geoData.lng = p.lng;
            $('#radar-lat').val(p.lat.toFixed(7));
            $('#radar-lon').val(p.lng.toFixed(7));
            updateHeadingLine(AppState.heading);
        });
    }
}

/* ============================================================
   Map rotation — bearing-up so heading arrow points to screen top
   ============================================================ */
function rotateMap(heading) {
    if (AppState.map && AppState.map.setBearing) {
        AppState.map.setBearing(-heading);
    }
}

/**
 * Offset a lat/lng point by dist metres in bearing direction (radians).
 */
function geoOffset(lat, lng, bearRad, distM) {
    const scale = 111320;
    return [
        lat + distM * Math.cos(bearRad) / scale,
        lng + distM * Math.sin(bearRad) / (scale * Math.cos(lat * Math.PI / 180))
    ];
}

/**
 * Draw/update the heading beam from radar position.
 * Extends beamLen metres in the heading direction.
 * Needle-point: filled arrowhead polygon at the beam tip.
 */
function updateHeadingLine(heading) {
    const lat = AppState.geoData.lat;
    const lng = AppState.geoData.lng;
    if (lat === 0 && lng === 0) return;

    const beamLen  = 100; // metres
    const bearRad  = heading * Math.PI / 180;
    const [endLat, endLng] = geoOffset(lat, lng, bearRad, beamLen);

    /* Beam line (stop short of arrowhead base, ~8 m) */
    const [baseLat, baseLng] = geoOffset(lat, lng, bearRad, beamLen - 8);
    if (AppState.headingLine) {
        AppState.headingLine.setLatLngs([[lat, lng], [baseLat, baseLng]]);
    } else {
        AppState.headingLine = L.polyline([[lat, lng], [baseLat, baseLng]], {
            color: '#0dcaf0', weight: 3, dashArray: '8 6'
        }).addTo(AppState.map);
    }

    /* Arrowhead: tip + two wing points 8 m back, ±30° off bearing */
    const wing  = 8;
    const spread = Math.PI / 6;
    const leftPt  = geoOffset(endLat, endLng, bearRad + Math.PI - spread, wing);
    const rightPt = geoOffset(endLat, endLng, bearRad + Math.PI + spread, wing);
    const arrowPts = [[endLat, endLng], leftPt, rightPt];
    if (AppState.headingArrow) {
        AppState.headingArrow.setLatLngs(arrowPts);
    } else {
        AppState.headingArrow = L.polygon(arrowPts, {
            color: '#0dcaf0', fillColor: '#0dcaf0', fillOpacity: 1, weight: 1
        }).addTo(AppState.map);
    }

    /* 180° FOV sector — radar at bottom-centre, arc from -90° to +90° of heading */
    const fovPts = [[lat, lng]];  // start at radar origin
    const steps  = 36;            // one point per 5° → smooth arc
    for (let i = 0; i <= steps; i++) {
        const angleDeg = (heading - 90) + i * (180 / steps);
        const angleRad = angleDeg * Math.PI / 180;
        fovPts.push(geoOffset(lat, lng, angleRad, beamLen));
    }
    fovPts.push([lat, lng]);      // close back to origin
    if (AppState.fovPolygon) {
        AppState.fovPolygon.setLatLngs(fovPts);
    } else {
        AppState.fovPolygon = L.polygon(fovPts, {
            color:       '#ffc107',
            weight:      2,
            dashArray:   '6 5',
            fillColor:   '#ffc107',
            fillOpacity: 0.07
        }).addTo(AppState.map);
        AppState.fovPolygon.bringToBack();
    }
}

/* ============================================================
   Compass SVG
   ============================================================ */
function updateCompass(deg) {
    document.getElementById('compass-arrow').setAttribute('transform', 'rotate(' + deg + ',30,30)');
}

/* Returns a fresh Leaflet divIcon crosshair for the radar position marker */
function radarCrosshairIcon() {
    return L.divIcon({
        className: '',
        html: '<svg width="28" height="28" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg">'
            + '<circle cx="14" cy="14" r="6" fill="#0d6efd" fill-opacity="0.95" stroke="#fff" stroke-width="2"/>'
            + '<line x1="14" y1="0"  x2="14" y2="9"  stroke="#0d6efd" stroke-width="2"/>'
            + '<line x1="14" y1="19" x2="14" y2="28" stroke="#0d6efd" stroke-width="2"/>'
            + '<line x1="0"  y1="14" x2="9"  y2="14" stroke="#0d6efd" stroke-width="2"/>'
            + '<line x1="19" y1="14" x2="28" y2="14" stroke="#0d6efd" stroke-width="2"/>'
            + '</svg>',
        iconSize:   [28, 28],
        iconAnchor: [14, 14]
    });
}

/* ============================================================
   Save
   ============================================================ */
function saveRadarConfig() {
    const lat     = parseFloat($('#radar-lat').val())     || 0;
    const lon     = parseFloat($('#radar-lon').val())     || 0;
    const heading = parseInt($('#radar-heading').val())   || 0;

    AppState.heading = heading;
    updateCompass(heading);

    if (lat !== 0 || lon !== 0) {
        placeRadarMarker(lat, lon);
        /* Pan to position if map is nowhere near it */
        AppState.map.setView([lat, lon], Math.max(AppState.map.getZoom(), 17));
    }
    updateHeadingLine(heading);
    rotateMap(heading);

    /* POST location + units to the standard settings endpoint.
     * ACAP.c persists the data and calls Settings_Updated_Callback,
     * which defers the VAPIX geolocation/sphere push to the main loop. */
    const units = parseInt($('#geo-units').val()) || 1;
    App.settings.scene = App.settings.scene || {};
    App.settings.scene.units = units;
    App.settings.location = { lat: lat, lon: lon, heading: heading };
    $.ajax({
        type: 'POST', url: 'settings',
        contentType: 'application/json',
        data: JSON.stringify({ location: App.settings.location, scene: App.settings.scene }),
        success: function() { showToast('Saved', 'success'); },
        error: function() { showToast('Save failed', 'danger'); }
    });
}

function saveSetting(payload) {
    $.ajax({
        type: 'POST', url: 'settings',
        contentType: 'application/json',
        data: JSON.stringify(payload)
    });
}

/* ============================================================
   MQTT
   ============================================================ */
function connectMQTT() {
    updateConnectionStatus('connecting');
    const clientID = 'WS-Geo-' + App.device.serial + '-' + Math.floor(Math.random() * 10000);
    if (MQTT_Client) delete MQTT_Client;

    const tls  = App.settings.tls || location.protocol === 'https:';
    const port = tls ? App.settings.WSS_Port : App.settings.WS_Port;

    MQTT_Client = new Paho.MQTT.Client(App.mqtt.address, port, clientID);
    MQTT_Client.onConnectionLost = function(r) {
        if (r.errorCode !== 0) {
            updateConnectionStatus('disconnected');
            showToast('Connection lost. Reconnecting…', 'warning');
            setTimeout(connectMQTT, 5000);
        }
    };
    MQTT_Client.onMessageArrived = onMessageArrived;

    const opts = {
        useSSL:   tls,
        timeout:  3,
        onSuccess: function() {
            updateConnectionStatus('connected');
            MQTT_Client.subscribe(App.mqtt.preTopic + '/geospace/' + App.device.serial);
        },
        onFailure: function(m) {
            updateConnectionStatus('disconnected');
            showToast(m.errorMessage + ' — check MQTT Settings', 'warning');
        }
    };
    if (App.mqtt.user     && App.mqtt.user.length)     opts.userName = App.mqtt.user;
    if (App.mqtt.password && App.mqtt.password.length) opts.password = App.mqtt.password;
    MQTT_Client.connect(opts);
}

function onMessageArrived(message) {
    const d = JSON.parse(message.payloadString);
    if (!d || !d.id) return;

    /* Format age label */
    let age = '';
    if (d.age != null) {
        if      (d.age > 3600) age = parseInt(d.age / 3600) + 'h';
        else if (d.age > 60)   age = parseInt(d.age / 60)   + 'm';
        else                   age = d.age.toFixed(1)        + 's';
    }

    const labelHtml = '<div class="tracker-label">' +
        (d.class || '?') + ' ' + age +
        (d.radar ? ' · ' + d.radar.speed.toFixed(1) : '') +
        '</div>';

    if (d.active) {
        const icon = L.divIcon({ className: '', html: labelHtml, iconAnchor: [0, 8] });
        if (AppState.trackers.has(d.id)) {
            const m = AppState.trackers.get(d.id);
            m.setLatLng([d.lat, d.lon]);
            m.setIcon(icon);
        } else {
            const m = L.marker([d.lat, d.lon], { icon }).addTo(AppState.map);
            AppState.trackers.set(d.id, m);
        }
    } else {
        if (AppState.trackers.has(d.id)) {
            AppState.map.removeLayer(AppState.trackers.get(d.id));
            AppState.trackers.delete(d.id);
        }
    }
}

/* ============================================================
   UI Helpers
   ============================================================ */
function updateConnectionStatus(status) {
    const el  = document.getElementById('connectionStatus');
    const msg = document.getElementById('statusMessage');
    const colours = { connected: '#00ff00', disconnected: '#ff0000', connecting: '#ffff00', reconnecting: '#ffff00' };
    el.style.backgroundColor = colours[status] || '#ffff00';
    msg.textContent = status.charAt(0).toUpperCase() + status.slice(1);
}

function showToast(message, type) {
    type = type || 'info';
    const tc = type === 'warning' ? 'text-dark' : 'text-white';
    const html =
        '<div class="toast align-items-center ' + tc + ' bg-' + type + ' border-0" role="alert">' +
        '<div class="d-flex"><div class="toast-body">' + message + '</div>' +
        '<button type="button" class="btn-close' + (type === 'warning' ? '' : ' btn-close-white') +
        ' me-2 m-auto" data-bs-dismiss="toast"></button></div></div>';
    const $t = $(html).appendTo('.toast-container');
    new bootstrap.Toast($t[0], { delay: 4000 }).show();
    $t[0].addEventListener('hidden.bs.toast', () => $t.remove());
}
</script>
</body>
</html>
