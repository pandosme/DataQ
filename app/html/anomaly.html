<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=1000, initial-scale=1.0">
  <title>Anomaly Configuration</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/app.css">
  <link rel="stylesheet" href="css/imgareaselect-default.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="js/jquery-3.7.1.min.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="js/media-stream-player.min.js"></script>
  <style>
    #video-view { position:relative; }
    .hidden { display: none !important; }
    .btn.active { outline: 3px solid #444 !important; }
    .stats-table th, .stats-table td { text-align: center; vertical-align: middle; }
    .stats-section { margin-top: 20px; margin-bottom: 30px; }
    .card-title { font-weight: bold; }
    .percent-label { font-size: 95%; color: #666; }
  </style>
</head>
<body>
<div class="d-flex" id="wrapper">
  <div class="bg-light border-right" id="sidebar-wrapper">
    <div class="sidebar-heading">&nbsp;</div>
    <div class="list-group list-group-flush">
      <a href="index.html" class="list-group-item list-group-item-action">Overview</a>
      <a href="events.html" class="list-group-item list-group-item-action">Events</a>
      <a href="detections.html" class="list-group-item list-group-item-action">Detections</a>
      <a href="trackers.html" class="list-group-item list-group-item-action">Trackers</a>
      <a href="paths.html" class="list-group-item list-group-item-action">Paths</a>
      <a href="occupancy.html" class="list-group-item list-group-item-action">Occupancy</a>
      <a href="anomaly.html" class="list-group-item list-group-item-action active">Anomaly</a>
      <a href="geospace.html" class="list-group-item list-group-item-action">Geospace</a>
      <a href="mqtt.html" class="list-group-item list-group-item-action">MQTT Settings</a>
      <a href="about.html" class="list-group-item list-group-item-action">About</a>
    </div>
  </div>
  <div id="page-content-wrapper" class="p-0">
    <div class="container-fluid">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div class="publish-control">
              <label class="switch">
                <input type="checkbox" id="pageToggle">
                <span class="slider round"></span>
              </label>
              <span class="switch-label">Anomaly configuration [BETA]</span>
            </div>
          </div>
          <div id="locationContent" class="location-content hidden">
            <div class="card-body" id="settings-form">
              <div class="row">
                <!-- Left column for video -->
                <div class="col-8" style="min-width: 800px">
                  <div id="video-view" style="display: inline-block; position:relative">
                    <div style="width:100%; height:100%; position:relative">
                      <div id="video" style="width:100%; height:100%; position:absolute; top:0; left:0;"></div>
                      <canvas id="detection-canvas" width="1000" height="1000"
                        style="width:100%; height:100%; position:absolute; top:0; left:0; pointer-events:none"></canvas>
                      <canvas id="settings-canvas" width="1000" height="1000"
                        style="width:100%; height:100%; position:absolute; top:0; left:0; z-index:12; cursor:crosshair"></canvas>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-12">
                      <!-- STATISTICS CARD START -->
                      <div class="card mb-4">
                        <div class="card-header d-flex align-items-center">
                          <i class="bi bi-bar-chart-line me-2"></i>
                          <span class="card-title mb-0">Statistics</span>
                        </div>
                        <div class="card-body" id="statistics-body">
                          <div class="row">
                            <div class="col-md-6 stats-section">
                              <h5>Humans</h5>
                              <table class="table table-bordered stats-table" id="stats-humans">
                                <thead class="table-light">
                                  <tr>
                                    <th>Field</th>
                                    <th>Lowest</th>
                                    <th>Average</th>
                                    <th>Highest</th>
                                    <th>97% Below</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <!-- filled by JS -->
                                </tbody>
                              </table>
                            </div>
                            <div class="col-md-6 stats-section">
                              <h5>Vehicles</h5>
                              <table class="table table-bordered stats-table" id="stats-vehicles">
                                <thead class="table-light">
                                  <tr>
                                    <th>Field</th>
                                    <th>Lowest</th>
                                    <th>Average</th>
                                    <th>Highest</th>
                                    <th>97% Below</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <!-- filled by JS -->
                                </tbody>
                              </table>
                            </div>
                          </div>
                          <small class="text-muted">
                            Statistics are updated every 30 seconds.<br>
                            Fields are left blank if not enough data is available.
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Right column: SETTINGS PANEL -->
                <div class="col-4">
                  <!-- Unmodified original settings card here as in your base HTML -->
                  <div class="card">
                    <div class="card-body">
                      <!-- HUMANS COLLAPSE -->
                      <div class="card mb-2">
                        <div class="card-header p-1 collapsed" data-bs-toggle="collapse" data-bs-target="#settings-humans" style="cursor:pointer;" aria-expanded="false" aria-controls="settings-humans">
                          <div class="fw-bold d-flex align-items-center"><span style="color:#888"><i class="bi bi-person"></i></span>&nbsp;Humans</div>
                        </div>
                        <div class="collapse" id="settings-humans">
                          <div class="card-body p-2">
                            <h6 class="mb-1">Areas</h6>
                            <div class="btn-group btn-group-sm d-flex mb-2" id="human-area-buttons">
                              <button id="btn-add-humans-common" class="btn btn-success">+ Common entry/exit</button>
                              <button id="btn-add-humans-restricted" class="btn btn-danger">+ Restricted</button>
                            </div>
                            <div class="d-flex justify-content-around mb-2" style="font-size:90%">
                              <div><span style="color:#44c044;font-weight:bold;">Common</span> <span id="human-common-count">0</span></div>
                              <div><span style="color:#ff4444;font-weight:bold;">Restricted</span> <span id="human-restricted-count">0</span></div>
                            </div>
                            <h6 class="mb-2 text-uppercase fw-bold" style="letter-spacing:1px;">Normal behaviour</h6>
                            <div class="row g-1">
                              <div class="col-12 mb-2">
                                <label class="form-label mb-0" for="human-max-changes">Max direction changes</label>
                                <input type="number" class="form-control form-control-sm human-setting" id="human-max-changes" min="0">
                              </div>
                              <div class="col-12 mb-2">
                                <label class="form-label mb-0" for="human-horiz">Horizontal direction</label>
                                <select class="form-select form-select-sm human-setting" id="human-horiz">
                                  <option value="Any">Any</option>
                                  <option value="Left">Left</option>
                                  <option value="Right">Right</option>
                                </select>
                              </div>
                              <div class="col-12 mb-2">
                                <label class="form-label mb-0" for="human-vert">Vertical direction</label>
                                <select class="form-select form-select-sm human-setting" id="human-vert">
                                  <option value="Any">Any</option>
                                  <option value="Up">Up</option>
                                  <option value="Down">Down</option>
                                </select>
                              </div>
                              <div class="col-12 mb-2">
                                <label class="form-label mb-0" for="human-idle">Max idle (s)</label>
                                <input type="number" class="form-control form-control-sm human-setting" id="human-idle" min="0">
                              </div>
                              <div class="col-12 mb-2">
                                <label class="form-label mb-0" for="human-age">Max age (s)</label>
                                <input type="number" class="form-control form-control-sm human-setting" id="human-age" min="0">
                              </div>
                              <div class="col-12 mb-2">
                                <label class="form-label mb-0" for="human-maxspeed">Max speed</label>
                                <input type="number" class="form-control form-control-sm human-setting" id="human-maxspeed" min="0">
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- VEHICLES COLLAPSE -->
                      <div class="card mb-2">
                        <div class="card-header p-1 collapsed" data-bs-toggle="collapse" data-bs-target="#settings-vehicles" style="cursor:pointer;" aria-expanded="false" aria-controls="settings-vehicles">
                          <div class="fw-bold d-flex align-items-center"><span style="color:#888"><i class="bi bi-truck"></i></span>&nbsp;Vehicles</div>
                        </div>
                        <div class="collapse" id="settings-vehicles">
                          <div class="card-body p-2">
                            <h6 class="mb-1">Areas</h6>
                            <div class="btn-group btn-group-sm d-flex mb-2" id="vehicle-area-buttons">
                              <button id="btn-add-vehicles-common" class="btn btn-success">+ Common entry/exit</button>
                              <button id="btn-add-vehicles-restricted" class="btn btn-danger">+ Restricted</button>
                            </div>
                            <div class="d-flex justify-content-around mb-2" style="font-size:90%">
                              <div><span style="color:#44c044;font-weight:bold;">Common</span> <span id="vehicle-common-count">0</span></div>
                              <div><span style="color:#ff4444;font-weight:bold;">Restricted</span> <span id="vehicle-restricted-count">0</span></div>
                            </div>
                            <h6 class="mb-2 text-uppercase fw-bold" style="letter-spacing:1px;">Normal behaviour</h6>
                            <div class="row g-1">
                              <div class="col-12 mb-2">
                                <label class="form-label mb-0" for="vehicle-max-changes">Max direction changes</label>
                                <input type="number" class="form-control form-control-sm vehicle-setting" id="vehicle-max-changes" min="0">
                              </div>
                              <div class="col-12 mb-2">
                                <label class="form-label mb-0" for="vehicle-horiz">Horizontal direction</label>
                                <select class="form-select form-select-sm vehicle-setting" id="vehicle-horiz">
                                  <option value="Any">Any</option>
                                  <option value="Left">Left</option>
                                  <option value="Right">Right</option>
                                </select>
                              </div>
                              <div class="col-12 mb-2">
                                <label class="form-label mb-0" for="vehicle-vert">Vertical direction</label>
                                <select class="form-select form-select-sm vehicle-setting" id="vehicle-vert">
                                  <option value="Any">Any</option>
                                  <option value="Up">Up</option>
                                  <option value="Down">Down</option>
                                </select>
                              </div>
                              <div class="col-12 mb-2">
                                <label class="form-label mb-0" for="vehicle-idle">Max idle (s)</label>
                                <input type="number" class="form-control form-control-sm vehicle-setting" id="vehicle-idle" min="0">
                              </div>
                              <div class="col-12 mb-2">
                                <label class="form-label mb-0" for="vehicle-age">Max age (s)</label>
                                <input type="number" class="form-control form-control-sm vehicle-setting" id="vehicle-age" min="0">
                              </div>
                              <div class="col-12 mb-2">
                                <label class="form-label mb-0" for="vehicle-maxspeed">Max speed</label>
                                <input type="number" class="form-control form-control-sm vehicle-setting" id="vehicle-maxspeed" min="0">
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <button id="save-anomaly-settings" class="btn btn-primary w-100 mt-3">
                        <i class="bi bi-save"></i> Save settings
                      </button>
                    </div>
                  </div>
                </div>
                <!-- END RIGHT COLUMN -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>
  </div>
</div>
<script>
let anomaly = null;
let currentGroup = null; // "humans" or "vehicles"
let CANVAS_SIZE = {w:800, h:450};
const HANDLE_SIZE = 9;
let selectedType = null, selectedIndex = -1, dragHandle = null, dragOffset = {}, isDragging = false;
let $canvas = null, ctx = null;

const AREA_COLOR = {
  common: "#44c044",
  restricted: "#ff4444"
};

function toPixel(xn, yn) { return [Math.round(xn * CANVAS_SIZE.w / 1000), Math.round(yn * CANVAS_SIZE.h / 1000)]; }
function fromPixel(x, y) { return [Math.round(x * 1000 / CANVAS_SIZE.w), Math.round(y * 1000 / CANVAS_SIZE.h)]; }
function areaNormToPix(area) { let [x1, y1] = toPixel(area.x1, area.y1), [x2, y2] = toPixel(area.x2, area.y2); return {x1, y1, x2, y2}; }
function areaPixToNorm(area) { let [x1, y1] = fromPixel(area.x1, area.y1), [x2, y2] = fromPixel(area.x2, area.y2); return {x1, y1, x2, y2}; }

function getAreasAllTypes(group) {
  return [
    ...anomaly[group].common.map((a,i)=>({a,i,type:'common'})),
    ...anomaly[group].restricted.map((a,i)=>({a,i,type:'restricted'}))
  ];
}
function getCurrentAreas(group) {return anomaly[group].common.concat(anomaly[group].restricted);}
function updateAreaCounts() {
  $("#human-common-count").text(anomaly.humans.common?.length || 0);
  $("#human-restricted-count").text(anomaly.humans.restricted?.length || 0);
  $("#vehicle-common-count").text(anomaly.vehicles.common?.length || 0);
  $("#vehicle-restricted-count").text(anomaly.vehicles.restricted?.length || 0);
}
// Set and get config settings for each group:
function setConfigToUI(anom) {
  const h = anom.humans.settings || {};
  $("#human-max-changes").val(h.directions ?? 0);
  $("#human-horiz").val(h.horizontal ?? "Any");
  $("#human-vert").val(h.vertical ?? "Any");
  $("#human-idle").val(h.idle ?? 0);
  $("#human-age").val(h.age ?? 0);
  $("#human-maxspeed").val(h.maxSpeed ?? 0);

  const v = anom.vehicles.settings || {};
  $("#vehicle-max-changes").val(v.directions ?? 0);
  $("#vehicle-horiz").val(v.horizontal ?? "Any");
  $("#vehicle-vert").val(v.vertical ?? "Any");
  $("#vehicle-idle").val(v.idle ?? 0);
  $("#vehicle-age").val(v.age ?? 0);
  $("#vehicle-maxspeed").val(v.maxSpeed ?? 0);
}
function getConfigFromUI() {
  function pruneSettings(source) {
    let result = {};
    if (source.directions && source.directions !== 0) result.directions = source.directions;
    if (source.horizontal && source.horizontal !== "Any") result.horizontal = source.horizontal;
    if (source.vertical && source.vertical !== "Any") result.vertical = source.vertical;
    if (source.idle && source.idle !== 0) result.idle = source.idle;
    if (source.age && source.age !== 0) result.age = source.age;
    if (source.maxSpeed && source.maxSpeed !== 0) result.maxSpeed = source.maxSpeed;
    return result;
  }
  let v = {
    directions: Number($("#vehicle-max-changes").val()) || 0,
    horizontal: $("#vehicle-horiz").val() || "Any",
    vertical: $("#vehicle-vert").val() || "Any",
    idle: Number($("#vehicle-idle").val()) || 0,
    age: Number($("#vehicle-age").val()) || 0,
    maxSpeed: Number($("#vehicle-maxspeed").val()) || 0
  };
  let h = {
    directions: Number($("#human-max-changes").val()) || 0,
    horizontal: $("#human-horiz").val() || "Any",
    vertical: $("#human-vert").val() || "Any",
    idle: Number($("#human-idle").val()) || 0,
    age: Number($("#human-age").val()) || 0,
    maxSpeed: Number($("#human-maxspeed").val()) || 0
  };
  return {
    vehicles: {settings: pruneSettings(v)},
    humans: {settings: pruneSettings(h)}
  };
}
function addDefaultArea(type, group) {
  let w=100,h=100;
  let [xn1, yn1] = fromPixel((CANVAS_SIZE.w-w)/2, (CANVAS_SIZE.h-h)/2);
  let [xn2, yn2] = fromPixel((CANVAS_SIZE.w-w)/2 + w, (CANVAS_SIZE.h-h)/2 + h);
  let area = {x1:xn1, y1:yn1, x2:xn2, y2:yn2};
  anomaly[group][type].push(area);
  selectedType = type;
  selectedIndex = anomaly[group][type].length-1;
  redrawAreas(group);
}
function cornersAndSides() { return ['nw','n','ne','e','se','s','sw','w']; }
function handlePos(a, handle) {
  let xm = (a.x1+a.x2)/2, ym = (a.y1+a.y2)/2;
  return {
    nw:[a.x1,a.y1], n:[xm,a.y1], ne:[a.x2,a.y1], e:[a.x2,ym], se:[a.x2,a.y2],
    s:[xm,a.y2], sw:[a.x1,a.y2], w:[a.x1,ym]
  }[handle];
}
function cursorForHandle(handle) {
  return { n:'ns-resize', s:'ns-resize', e:'ew-resize', w:'ew-resize',
           nw:'nwse-resize', se:'nwse-resize', ne:'nesw-resize', sw:'nesw-resize', move:'move'
         }[handle] || 'default';
}
function pointInRect(x, y, areaPix) {
  return x>=areaPix.x1&&x<=areaPix.x2&&y>=areaPix.y1&&y<=areaPix.y2;
}
function resizeArea(a, handle, mx, my) {
  switch (handle) {
    case 'nw': a.x1=mx; a.y1=my; break;
    case 'n': a.y1=my; break;
    case 'ne': a.x2=mx; a.y1=my; break;
    case 'e': a.x2=mx; break;
    case 'se': a.x2=mx; a.y2=my; break;
    case 's': a.y2=my; break;
    case 'sw': a.x1=mx; a.y2=my; break;
    case 'w': a.x1=mx; break;
  }
  a.x1 = Math.max(0, Math.min(CANVAS_SIZE.w-1, a.x1));
  a.y1 = Math.max(0, Math.min(CANVAS_SIZE.h-1, a.y1));
  a.x2 = Math.max(a.x1+10, Math.min(CANVAS_SIZE.w, a.x2));
  a.y2 = Math.max(a.y1+10, Math.min(CANVAS_SIZE.h, a.y2));
}
function installAreaHandlers(group) {
  $("#settings-canvas").off(".areaop");
  $("#btn-add-" + group + "-common").on("click", function(){addDefaultArea('common', group);});
  $("#btn-add-" + group + "-restricted").on("click", function(){addDefaultArea('restricted', group);});
  $("#settings-canvas").on("mousedown.areaop", function(e) {
    let {offsetX:mx, offsetY:my} = e;
    let handled=false;
    let found=null;
    getAreasAllTypes(group).forEach(obj=>{
      cornersAndSides().forEach(handle=>{
        let [hx, hy] = handlePos(areaNormToPix(obj.a), handle);
        if(Math.abs(mx-hx)<=HANDLE_SIZE && Math.abs(my-hy)<=HANDLE_SIZE) found={type:obj.type,idx:obj.i,handle};
      });
    });
    if(found) {
      selectedType=found.type; selectedIndex=found.idx; dragHandle=found.handle; isDragging=true; dragOffset={x:mx,y:my}; redrawAreas(group); handled=true;
    }
    if(!handled){
      let candidates=[];
      getAreasAllTypes(group).forEach(obj=>{
        let ap = areaNormToPix(obj.a);
        if(pointInRect(mx,my,ap)) candidates.push({...obj, areaPix:ap});
      });
      if(candidates.length){
        let winner=candidates[candidates.length-1];
        selectedType=winner.type; selectedIndex=winner.i; dragHandle='move'; isDragging=true;
        let ap=areaNormToPix(anomaly[group][selectedType][selectedIndex]);
        dragOffset={x:mx-ap.x1, y:my-ap.y1};
        redrawAreas(group); handled=true;
      }
    }
    if(!handled){selectedType=null;selectedIndex=-1;dragHandle=null;redrawAreas(group);}
  });
  $("#settings-canvas").on("mousemove.areaop", function(e){
    let {offsetX:mx,offsetY:my}=e;
    let cursor='';
    if(isDragging && selectedType!==null && selectedIndex!==-1){
      let areaNorm = anomaly[group][selectedType][selectedIndex];
      if(dragHandle && dragHandle!=='move'){
        let areaPix=areaNormToPix(areaNorm);
        resizeArea(areaPix, dragHandle, mx, my);
        Object.assign(anomaly[group][selectedType][selectedIndex], areaPixToNorm(areaPix));
        redrawAreas(group); cursor=cursorForHandle(dragHandle);
      } else if(dragHandle==='move'){
        let areaPix = areaNormToPix(areaNorm);
        let w=areaPix.x2-areaPix.x1, h=areaPix.y2-areaPix.y1, nx1=mx-dragOffset.x, ny1=my-dragOffset.y;
        nx1=Math.min(Math.max(0,nx1), CANVAS_SIZE.w-w); ny1=Math.min(Math.max(0,ny1), CANVAS_SIZE.h-h);
        areaPix.x1=nx1; areaPix.y1=ny1; areaPix.x2=nx1+w; areaPix.y2=ny1+h;
        Object.assign(anomaly[group][selectedType][selectedIndex], areaPixToNorm(areaPix));
        redrawAreas(group); cursor='move';
      }
    } else {
      let found=null;
      getAreasAllTypes(group).forEach(obj=>{
        cornersAndSides().forEach(handle=>{
          let [hx, hy] = handlePos(areaNormToPix(obj.a), handle);
          if(Math.abs(mx-hx)<=HANDLE_SIZE && Math.abs(my-hy)<=HANDLE_SIZE) found=cursorForHandle(handle);
        });
      });
      if(!found && selectedType!==null && selectedIndex!==-1){
        let ap = areaNormToPix(anomaly[group][selectedType][selectedIndex]);
        if(pointInRect(mx,my,ap)) found="move";
      }
      cursor=found||"default";
    }
    $canvas.style.cursor=cursor;
  });
  $("#settings-canvas").on("mouseup.areaop mouseleave.areaop", function(e) {
    isDragging=false; dragHandle=null; redrawAreas(group);
  });
  $(document).off("keydown.areadel").on("keydown.areadel", function(e){
    if(e.key==="Delete" && selectedType!==null && selectedIndex!==-1) {
      anomaly[group][selectedType].splice(selectedIndex,1); selectedType=null; selectedIndex=-1; redrawAreas(group);
    }
  });
}
function redrawAreas(group) {
  if(!ctx) return;
  ctx.clearRect(0,0,$canvas.width,$canvas.height);
  [["common",AREA_COLOR.common],["restricted",AREA_COLOR.restricted]].forEach(([type,color])=>{
    (anomaly[group][type]||[]).forEach((areaNorm,i)=>{
      let a=areaNormToPix(areaNorm);
      ctx.save();
      ctx.strokeStyle=color; ctx.lineWidth=2; ctx.globalAlpha=1;
      ctx.strokeRect(a.x1,a.y1,a.x2-a.x1,a.y2-a.y1);
      if (type===selectedType && i===selectedIndex) {
        ctx.lineWidth=3; ctx.setLineDash([4,4]);
        ctx.strokeRect(a.x1-2,a.y1-2,a.x2-a.x1+4,a.y2-a.y1+4);
        ctx.setLineDash([]);
        cornersAndSides().forEach(handle=>{
          let [hx,hy]=handlePos(a,handle);
          ctx.fillStyle="#FFF"; ctx.strokeStyle="#000"; ctx.lineWidth=1.5;
          ctx.fillRect(hx-HANDLE_SIZE, hy-HANDLE_SIZE, HANDLE_SIZE*2, HANDLE_SIZE*2);
          ctx.strokeRect(hx-HANDLE_SIZE, hy-HANDLE_SIZE, HANDLE_SIZE*2, HANDLE_SIZE*2);
        });
      }
      ctx.restore();
    });
  });
  updateAreaCounts();
}
function restoreAreas(group) {
  if (!anomaly[group].common) anomaly[group].common = [];
  if (!anomaly[group].restricted) anomaly[group].restricted = [];
  selectedType = null; selectedIndex = -1; updateAreaCounts(); redrawAreas(group);
}
function save() {
  let values = getConfigFromUI();

  let result = {
    humans: {
      common: anomaly.humans.common,
      restricted: anomaly.humans.restricted,
      settings: values.humans.settings
    },
    vehicles: {
      common: anomaly.vehicles.common,
      restricted: anomaly.vehicles.restricted,
      settings: values.vehicles.settings
    }
  };
  var payload = { anomaly: result };

  $.ajax({
    type: "POST",
    url: 'settings',
    contentType: 'application/json',
    data: JSON.stringify(payload),
    success: function() {
      showToast("Anomaly configuration saved",'info');
    },
    error: function() {
      showToast("Failed to save anomaly configuration",'danger');
    }
  });
}
$("#save-anomaly-settings").on("click", function(){ save(); });
$(document).ready(function(){
  $.ajax({
    type: "GET",
    url: 'app',
    dataType: 'json',
    cache: false,
    success: function(data) {
      window.app = data;
      const toggle = document.getElementById('pageToggle');
      const content = document.getElementById('locationContent');
      toggle.checked = window.app.settings.publish.anomaly;
      content.classList.toggle('hidden', !window.app.settings.publish.anomaly);
      const aspectRatio = window.app.device.aspect || '16:9';
      const rotation = window.app.settings.scene.rotation || 0;
      PlayVideo(aspectRatio, rotation);

      // Rebuild anomaly state to have per-group areas
      if (!window.app.settings.anomaly) window.app.settings.anomaly = {};
      if (!window.app.settings.anomaly.humans) window.app.settings.anomaly.humans = {common:[],restricted:[],settings:{}};
      if (!window.app.settings.anomaly.vehicles) window.app.settings.anomaly.vehicles = {common:[],restricted:[],settings:{}};
      anomaly = window.app.settings.anomaly;
      setConfigToUI(anomaly);
      updateAreaCounts();

      // Start with both sections collapsed and no areas drawn
      $(".collapse").removeClass("show");
      selectedType = null; selectedIndex = -1;
      currentGroup = null;
      ctx = $("#settings-canvas")[0].getContext("2d");
      $canvas = $("#settings-canvas")[0];
      ctx.clearRect(0,0,$canvas.width,$canvas.height);

      function switchAreaPanel(groupName) {
        currentGroup = groupName;
        restoreAreas(groupName);
        installAreaHandlers(groupName);
      }
      $("#settings-humans").on("show.bs.collapse", function() {
        switchAreaPanel("humans");
      });
      $("#settings-vehicles").on("show.bs.collapse", function() {
        switchAreaPanel("vehicles");
      });

      // Collapse other group when switching
      $("#settings-humans").on("show.bs.collapse", function() {
        $("#settings-vehicles").collapse("hide");
      });
      $("#settings-vehicles").on("show.bs.collapse", function() {
        $("#settings-humans").collapse("hide");
      });

      // Initial handler install is inactive until reveal
      // Only show or draw areas when a panel opens
	  updateStatistics();
	  setInterval(updateStatistics, 30000); // Every 30 seconds
  
      toggle.addEventListener('change', async function() {
        try {
          window.app.settings.publish.anomaly = this.checked;
          var payload = { publish: window.app.settings.publish };
          $.ajax({type: "POST", url: 'settings', contentType: 'application/json', data: JSON.stringify(payload)});
          content.classList.toggle('hidden', !this.checked);
          if(this.checked){
            const aspectRatio = window.app.device.aspect || '16:9';
            const rotation = window.app.settings.scene.rotation || 0;
            PlayVideo(aspectRatio, rotation);
            ctx = $("#settings-canvas")[0].getContext("2d");
            $canvas = $("#settings-canvas")[0];
            ctx.clearRect(0,0,$canvas.width,$canvas.height);
            selectedType = null; selectedIndex = -1;
          } else {
            $("#video").empty();
            if(ctx) ctx.clearRect(0,0,$canvas.width,$canvas.height);
          }
        } catch (error) { this.checked = !this.checked; alert('Failed to update anomaly setting'); }
      });
    }
  });
});

function formatStat(val) {
  if (val === null || val === undefined || isNaN(val)) return '';
  if (typeof val === 'number') return Math.round(val);
  return val;
}

// Compute stats: lowest, average, highest, 95th percentile
function computeStats(samples) {
  let arr = (samples || []).filter(x => typeof x === 'number' && !isNaN(x));
  if (arr.length < 8) return {low:'',avg:'',high:'',p95:''};
  arr.sort((a,b)=>a-b);
  // For directions, 97% below must show at least 1 if there are nonzero values in data
  const isDir = arr.every(x=>x===0||x===1);
  let p95_val = arr[Math.floor(arr.length*0.97)-1];
  if (isDir && p95_val === 0 && arr.some(x=>x===1)) p95_val = 1;
  return {
    low: Math.round(arr[0]),
    avg: Math.round(arr.reduce((a,b)=>a+b,0)/arr.length),
    high: Math.round(arr[arr.length-1]),
    p95: Math.round(p95_val),
  };
}

// For horizontal/vertical: percent left/up (neg), right/down (pos)
function computeDirectionPerc(arr, labelNeg, labelPos) {
  let n = (arr || []).length;
  if (n < 8) return {low:'',high:''};
  let pos = arr.filter(x=>x>0).length;
  let neg = arr.filter(x=>x<0).length;
  let percentNeg = Math.round((neg/n)*100);
  let percentPos = Math.round((pos/n)*100);
  return {
    low: percentNeg>0?`${percentNeg}% ${labelNeg}`:'',
    high: percentPos>0?`${percentPos}% ${labelPos}`:''
  };
}

// Build rows for the table
function renderStatsRows(stats) {
  let rows = '';
  rows += `<tr>
    <td>Directions</td>
    <td>${formatStat(stats.directions.low)}</td>
    <td>${formatStat(stats.directions.avg)}</td>
    <td>${formatStat(stats.directions.high)}</td>
    <td>${formatStat(stats.directions.p95)}</td>
  </tr>`;
  rows += `<tr>
    <td>Age (s)</td>
    <td>${formatStat(stats.age.low)}</td>
    <td>${formatStat(stats.age.avg)}</td>
    <td>${formatStat(stats.age.high)}</td>
    <td>${formatStat(stats.age.p95)}</td>
  </tr>`;
  rows += `<tr>
    <td>Idle (s)</td>
    <td>${formatStat(stats.idle.low)}</td>
    <td>${formatStat(stats.idle.avg)}</td>
    <td>${formatStat(stats.idle.high)}</td>
    <td>${formatStat(stats.idle.p95)}</td>
  </tr>`;
  rows += `<tr>
    <td>Speed</td>
    <td>${formatStat(stats.speed.low)}</td>
    <td>${formatStat(stats.speed.avg)}</td>
    <td>${formatStat(stats.speed.high)}</td>
    <td>${formatStat(stats.speed.p95)}</td>
  </tr>`;
  rows += `<tr>
    <td>Horizontal</td>
    <td>${stats.horizontal.low}</td>
    <td></td>
    <td>${stats.horizontal.high}</td>
    <td></td>
  </tr>`;
  rows += `<tr>
    <td>Vertical</td>
    <td>${stats.vertical.low}</td>
    <td></td>
    <td>${stats.vertical.high}</td>
    <td></td>
  </tr>`;
  return rows;
}

// Fetch & calculate statistics, fill tables
function updateStatistics() {
  $.getJSON('status', function(status) {
    let humans = status.humans || {};
    let vehicles = status.vehicles || {};

    function getArray(prop) {
      return Array.isArray(prop) ? prop : [];
    }

    // Humans
    let humanStats = {
      directions: computeStats(getArray(humans.directions)),
      age: computeStats(getArray(humans.age)),
      idle: computeStats(getArray(humans.idle)),
      speed: computeStats(getArray(humans.speed)),
      horizontal: computeDirectionPerc(getArray(humans.horizontal), 'Left', 'Right'),
      vertical: computeDirectionPerc(getArray(humans.vertical), 'Up', 'Down')
    };

    // Vehicles
    let vehicleStats = {
      directions: computeStats(getArray(vehicles.directions)),
      age: computeStats(getArray(vehicles.age)),
      idle: computeStats(getArray(vehicles.idle)),
      speed: computeStats(getArray(vehicles.speed)),
      horizontal: computeDirectionPerc(getArray(vehicles.horizontal), 'Left', 'Right'),
      vertical: computeDirectionPerc(getArray(vehicles.vertical), 'Up', 'Down')
    };
    // Update tables
    $('#stats-humans tbody').html(renderStatsRows(humanStats));
    $('#stats-vehicles tbody').html(renderStatsRows(vehicleStats));
  });
}


function PlayVideo(aspect, rotation) {
  let width=800, height=450, videoWidth=1280, videoHeight=720;
  switch (aspect) {
    case '4:3': width=800; height=600; videoWidth=800; videoHeight=600; break;
    case '1:1': width=640; height=640; videoWidth=640; videoHeight=640; break;
    case '16:10': width=800; height=500; videoWidth=800; videoHeight=500; break;
    default: width=800; height=450; videoWidth=1280; videoHeight=720; break;
  }
  if(rotation===90||rotation===270){ let t=width;width=height;height=t; }
  CANVAS_SIZE={w:width, h:height};
  $("#video-view").css("width",width+"px").css("height",height+"px");
  $("#detection-canvas").attr("width",width).attr("height",height)
    .css("width",width+"px").css("height",height+"px");
  $("#settings-canvas").attr("width",width).attr("height",height)
    .css("width",width+"px").css("height",height+"px");
  let player = `<media-stream-player hostname="${window.location.hostname}"
    format="RTP_H264" compression="40" audio="0"
    resolution="${videoWidth}x${videoHeight}" variant="basic" autoplay></media-stream-player>`;
  $("#video").empty().append(player);
  $canvas = $("#settings-canvas")[0];
  ctx = $canvas.getContext("2d");
}
function showToast(message, type = 'info') {
  const toastContainer = document.querySelector('.toast-container');
  const textColorClass = (type === 'warning' ? 'text-dark' : 'text-white');
  const toastHtml = `
  <div class="toast align-items-center ${textColorClass} bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close${type === 'warning' ? '' : ' btn-close-white'} me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>`;
  toastContainer.insertAdjacentHTML('beforeend', toastHtml);
  const toastElement = toastContainer.lastElementChild;
  const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 4000 });
  toast.show();
  toastElement.addEventListener('hidden.bs.toast', function() { this.remove(); });
}
</script>

</body>
</html>