<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/app.css">
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <div class="d-flex" id="wrapper">
        <!-- Sidebar -->
        <div class="bg-light border-right" id="sidebar-wrapper">
            <div class="sidebar-heading">&nbsp;</div>
            <div class="list-group list-group-flush">
                <a href="index.html" class="list-group-item list-group-item-action">Publish</a>
                <a href="events.html" class="list-group-item list-group-item-action">Events</a>
                <a href="detections.html" class="list-group-item list-group-item-action">Detections</a>
                <a href="trackers.html" class="list-group-item list-group-item-action">Trackers</a>
                <a href="paths.html" class="list-group-item list-group-item-action">Paths</a>
                <a href="occupancy.html" class="list-group-item list-group-item-action">Occupancy</a>
                <a href="anomaly.html" class="list-group-item list-group-item-action">Anomaly</a>
                <a href="geospace.html" class="list-group-item list-group-item-action">Geospace</a>
                <a href="mqtt.html" class="list-group-item list-group-item-action">MQTT Settings</a>
                <a href="about.html" class="list-group-item list-group-item-action">About</a>
            </div>
        </div>
        <div id="page-content-wrapper" class="p-5">
            <div class="container-fluid">
                <div class="row justify-content-center">
                    <div class="col-12 col-lg-8">
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">Advanced settings</h5>
                            </div>
                            <div class="card-body" id="settings-form">
								<div class="row g-4 align-items-center">
									<div class="col-md-6">
										<div class="form-label mb-1">Tracker Predictions</div>
										<div class="text-muted small mb-2">
											Include predicted detection positions.<br>
											Change requires ACAP restart.
										</div>
									</div>
									<div class="col-md-6 text-end">
										<div class="form-check form-switch d-inline-flex align-items-center">
											<input class="form-check-input" type="checkbox" id="tracker-predictions-switch">
											<label class="form-check-label ms-2" for="tracker-predictions-switch">
												Enable Predictions
											</label>
										</div>
									</div>
									<hr class="my-2"/>
									<div class="col-md-6">
										<div class="form-label mb-1">Path Stitch Angle Threshold</div>
										<div class="text-muted small mb-2">
											Defines the limit trajectory angles for stitching paths.
										</div>
									</div>
									<div class="col-md-6 text-end">
										<input type="number" id="angle-threshold-input" class="form-control w-50 d-inline-block" min="20" max="60" step="5">
									</div>
								</div>
							</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="toast-container position-fixed top-0 end-0 p-3"></div>
    </div>

<script>
let appData = null;



function updateSetting(path, value) {
    if (!appData) return;

    // Update the value in the appData object
    let keyParts = path.split('.');
    let obj = appData.settings;
    for (let i = 0; i < keyParts.length - 1; i++) {
        obj = obj[keyParts[i]];
        if (!obj) return;
    }
    obj[keyParts[keyParts.length - 1]] = value;

    // Prepare payload for both scene and stitch (for safety)
    let payload = {
        scene: appData.settings.scene,
        stitch: appData.settings.stitch
    };

    let url = 'settings?json=' + encodeURIComponent(JSON.stringify(payload));
    $.ajax({
        type: "GET",
        url: url,
        success: function(response) {
            showToast('Settings updated', 'info');
        },
        error: function(xhr, status, error) {
            showToast('Settings update failed', 'danger');
        }
    });
}

$(document).ready(function() {
    $.ajax({
        type: "GET",
        url: 'app',
        dataType: 'json',
        cache: false,
        success: function(app) {
            appData = app;
            document.title = app.manifest.acapPackageConf.setup.friendlyName;
            $('.sidebar-heading').text(app.manifest.acapPackageConf.setup.friendlyName);

            // -- TRACKER PREDICTIONS SWITCH: checked if tracker_confidence is FALSE --
			$('#tracker-predictions-switch').prop('checked', !app.settings.scene.tracker_confidence);
            // -- PATH STITCH ANGLE THRESHOLD --
            $('#angle-threshold-input').val(
                typeof app.settings.stitch.angle_threshold === "number" 
                ? app.settings.stitch.angle_threshold : 40
            );
        },
        error: function(response) { showToast(response.statusText, 'danger'); }
    });

    // Inverted logic: predictions enabled if tracker_confidence is FALSE
	$('#tracker-predictions-switch').on('change', function() {
		if (!appData) return;
		appData.settings.scene.tracker_confidence = !$(this).is(':checked');
		const payload = {
			scene: appData.settings.scene,
		};
		$.ajax({
			type: "POST",
			url: 'settings',
			contentType: 'application/json',
			data: JSON.stringify(payload),
			success: () => showToast('Settings updated', 'info'),
			error: () => showToast('Settings update failed', 'danger')
		});
	});

    $('#angle-threshold-input').on('change', function() {
        if (!appData) return;
        let val = Math.round(parseInt(this.value, 10) / 5) * 5;
        if (isNaN(val)) val = 40;
        if (val < 20) val = 20;
        if (val > 60) val = 60;
        this.value = val;
        appData.settings.stitch.angle_threshold = val;
		const payload = {
			stitch: appData.settings.stitch
		};
		$.ajax({
			type: "POST",
			url: 'settings',
			contentType: 'application/json',
			data: JSON.stringify(payload),
			success: () => showToast('Settings updated', 'info'),
			error: () => showToast('Settings update failed', 'danger')
		});
    });
});

function showToast(message, type = 'danger') {
    const toastContainer = document.querySelector('.toast-container');
    const textColorClass = type === 'warning' ? 'text-dark' : 'text-white';
    toastContainer.insertAdjacentHTML('beforeend', `
        <div class="toast align-items-center ${textColorClass} bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close${type === 'warning' ? '' : ' btn-close-white'} me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `);
    const toastEl = toastContainer.lastElementChild;
    new bootstrap.Toast(toastEl, {autohide: true, delay: 4000}).show();
    toastEl.addEventListener('hidden.bs.toast', function() { this.remove(); });
}

</script>
</body>
</html>
